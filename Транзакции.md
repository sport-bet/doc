# Транзакции

## Создание федерации
Любой аккаунт (участник сети) может создать собственную федерацию. Федерация определяет правила проведения турниров, 
правила расчета рейтинга и присвоения разряда игрокам.

### Атрибуты отправляемые в сеть:
```
federation_key: publickey; // Публичный ключ федерации (генерируется клиентом)
owner_key: publickey; // Публичный ключ создателя (владельца) федерации
min_count_players: int; // Мин. кол-во игроков в турнире
max_count_players: int; // Макс. кол-во игроков в турнире
min_count_judges: int; // Мин. кол-во судей в турнире
max_count_judges: int; // Макс. кол-во судей в турнире
lowest_rank: int; // Низший разряд. Высшим разрядом всегда считается 0
lower_level_points: double; // Баллов за победу над соперником низшего разряда
same_level_points: double; // Баллов за победу над соперником того же разряда
top_level_points: double; // Баллов за победу над соперником высшего разряда
tournament_points: double; // Баллов за победу в турнире
next_rank_points: double; // Кол-во баллов для присвоения следующего разряда
created_at: timestamp; // Дата создания федерации
```
### Дополнительные атрибуты вне сети:
```
name: string; // Название федерации
...
```
```
Справочник разрядов. Например:
    0 - МС
    1 - КМС
    2 - разряд 1
    ...
```
##### Валидация:
1. Федерации с таким federation_key еще не существует.
2. author транзакции равен owner_key.
3. Мин. кол-во судей нечетное.
4. Макс. кол-во судей нечетное.
5. Мин. и макс. кол-во участников четное.
6. lowest_rank > 0 .
7. ..._points >= 0

## Завка на включение в федерацию
Любой аккаунт может подать заявку на включение его в федерацию, указав при этом свои начальные роли и разряд. 

### Атрибуты отправляемые в сеть:
````
order_key: publickey; // Публичный ключ заявления (генерируется клиентом)
declarer_key: publickey; // Публичный ключ заявителя
federation_key: publickey; // Публичный ключ федерации
player: bool; // Роль Игрок
judge: bool; // Роль Судья
arbiter: bool; // Роль Арбитр
rank: int; // Разряд
created_at: timestamp; // Дата формирования заявления
````
### Дополнительные атрибуты вне сети:
````
description: string // Описание: "Я Иванов ... прошу включить меня в федерацию на основании ... и присвоить рейтинг ..."
...
````
### Валидация:
1. Заявление с данным order_key еще не существует.
2. Существует federation_key.
3. declarer_key еще не включен в federation_key.
4. rank >= 0 && rank <= lowest_rank
	
## Заявка на изменение ролей
После выполнения определенных условий (получение определенного разряда, внесение взноса) 
(выполнение этих условий контролируется за пределами сети) участник федерации имеет право подать заявку на изменение своих ролей.

### Атрибуты отправляемые в сеть:
```
order_key: publickey; // Публичный ключ заявления (генерируется клиентом)
declarer_key: publickey; // Публичный ключ заявителя
federation_key: publickey; // Публичный ключ федерации
player: bool; // Игрок
judge: bool; // Судья
arbiter: bool; // Арбитр
created_at: timestamp; // Дата формирования заявления
```
### Дополнительные атрибуты вне сети:
```
description: string // Описание: "Я Иванов ... прошу перевести разрешить мне выполнять функции арбитра т.к. я заплатил денег и получил соответствующий разряд как игрок"
...
```
### Валидация:
1. Заявление с данным order_key еще не существует.
2. Существует federation_key.
3. declarer_key входит в federation_key.
		
## Подтверждение/отклонение заявок
Создатель федерации имеет право принять или отклонить заявку. 

### Атрибуты отправляемые в сеть:
```
order_key: publickey; // Публичный ключ заявления
result: bool; // Принята/отклонена
```
### Валидация:
1. Заявление с order_key существует.
2. Владельцем федерации federation_key является author транзакции подтверждения.
3. Зявитель declarer_key еще не состоит в федерации (для заявки на включение)
3. Зявитель declarer_key состоит в федерации (для заявки на изменение ролей)
		
## Односторонне исключение из федерации
```
... // TODO
```

## Добровольный выход из федерации
```
... // TODO
```

## Создание турнира
Аккаунт состоящий в федерации и имеющий роль Арбитр может создавать турниры.

### Атрибуты отправляемые в сеть:
```
tournament_key: publickey; // Публичный ключ турнира (генерируется клиентом)
arbiter_key: publickey; // Публичный ключ арбитра турнира
federation_key: publickey; // Публичный ключ федерации
count_players: int; // Заявленное количество участников
count_judges: int; // Заявленное количество судей
```
### Дополнительные атрибуты вне сети:
```
name: string;
address: string;
date_from: timestamp;
date_to: timestamp;
....
```
### Валидация:
1. Турнир с заданным tournament_key еще не существует.
2. author тарнзакции совпадает с arbiter_key.
3. author входжит в federation_key.
4. count_players >= min_count_players && count_players <= max_count_players
5. count_judges >= min_count_judges && count_judges <= max_count_judges
6. count_players четное.
7. count_judges нечетное.
			
## Заявка на турнир
Аккаунты состоящие в федерации и имеющие роль Игрок могут завялятся на участие в турнире в роле игрока.
Аккаунты состоящие в федерации и имеющие роль Судья могут завялятся на участие в турнире в роли судьи.
Если один заявитель подал несколько заявок на участие в турнире, то рассматривается только последняя.
Прием заявок заканчивается после создания первого поединка.

### Атрибуты отправляемые в сеть:
```
order_key: publickey; // Публичный ключ заявления (генерируется клиентом)
tournament_key: publickey; // Публичный ключ турнира
declarer_key: publickey; // Публичный ключ заявителя (автора транзакции)
federation_key: publickey; // Публичный ключ федерации
player: bool; // Признак того, что заявитель хочет быть игроком в рамках турнира
judge: bool; // Признак того, что заявитель хочет быть судьей в рамках турнира
created_at: timestamp; // Дата формирования заявления
```
### Валидация:
1. Заявление с order_key существует.
2. Федерация federation_key существует.
3. Турнир tournament_key проводится в рамках федерации federation_key.
4. Заявитель declarer_key входит в федерацию federation.
5. Заявитель declarer_key может выполнять заявленную роль в рамках федерации.
6. Заявлена только одна роль ((player || judge) && !(player && judge))
7. Продолжается прием заявок.

## Создание поединка
Если поступило достаточное количество заявок на роли игроков и судей, то арбитр может создавать поединки.

### Атрибуты отправляемые в сеть:
```
duel_key: publickey; // Публичный ключ поединка (генерируется клиентом)
tournament_key: publickey; // Публичный ключ турнира
player1: publickey; // Публичный ключ первого игрока
player2: publickey; // Публичный ключ второго игрока
judges: List<publickey>; // Публичные ключи судей
situation_number: int; // Номер ситуации
```
### Валидация:
1. Поединок с данным duel_key не существует.
2. author транзакции является арбитром в данном турнире tournament_key.
3. player1 заявлялся на турнир в роле игрока.
4. player2 заявлялся на турнир в роле игрока.
5. player1 != player2.
6. Количество судей соответствует регламенту турнира.
7. Все судьи заявлялись на турнир в роле судьи.
8. Ситуацию situation_number еще не разыгрывали в рамках данного турнира.
9. В рамках турнира данные игроки могут встретится т.е. соответствует ли создаваемый поединок олимпиадной схеме.

## Подтверждение готовности начать поединок
Поединок начинается после того как от всех участников поступило подтверждение о готовности.

### Атрибуты отправляемые в сеть:
```
duel_key: publickey; // Публичный ключ поединка
participant_key: publickey; // Публичный ключ участника (игрока, судьи, арбитра)
```
### Валидация:
1. Поединок duel_key существует.
2. participant_key является участником поединка.

// TODO подтверждение от игроков от том, что они закончили свои выступления

## Голосование судьи
До завершения поединка (до формирования соответствующей транзакции арбитром) судья может проголосовать один раз 
и только за одного игрока.

### Атрибуты отправляемые в сеть:
```
duel_key: publickey; // Публичный ключ поединка
player_key: publickey; // Публичный ключ игрока за которого голосует судья
```
### Валидация:
1. Поединок duel_key существует.
2. Поединок не завершен.
3. Author транзакции является судьей в данном поединке.
4. Судья еще не голосовал в данном поединке.
5. player_key является участником поединка.

## Завершение поединка арбитром.
После того как все судьи проголосовали арбитр может завершить поединок.
После завершения поединка сеть определяет победителя поединка и увеличивает его рейтинг по правилам заданными федерацией.

### Атрибуты отправляемые в сеть:
```
duel_key: publickey; // Публичный ключ поединка
```
### Валидация:
1. Поединок duel_key существует.
2. Поединок не завершен.
3. Author транзакции является арбитром в данном поединке.
4. Все судьи в данном поединке проголосовали.


## TODO Завершение турнира арбитром.





## TODO Ведени тренировок
